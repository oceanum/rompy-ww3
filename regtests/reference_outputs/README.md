# WW3 Reference Outputs for Regression Testing

This directory contains reference outputs from official WAVEWATCH III (WW3) model runs for comparison with rompy-ww3 results.

## Purpose

Reference outputs serve as the "gold standard" for validating rompy-ww3 implementations. By comparing rompy-ww3 results against official WW3 outputs, we can verify:

1. **Configuration Correctness**: Namelists generated by rompy-ww3 produce equivalent model runs
2. **Physics Accuracy**: Wave physics are correctly reproduced
3. **Numerical Precision**: Results match within acceptable tolerances
4. **Regression Detection**: Changes to rompy-ww3 don't break existing functionality

## WW3 Version

**Current Reference Version**: WW3 v6.07.1
- **Release Date**: 2021-03-15
- **GitHub Tag**: [6.07.1](https://github.com/NOAA-EMC/WW3/releases/tag/6.07.1)
- **Commit SHA**: To be determined from local WW3 installation

## Directory Structure

```
reference_outputs/
├── README.md                    # This file
├── CHECKSUMS.txt                # SHA256 checksums for all reference files
├── generate_references.sh       # Script to generate reference outputs from WW3
├── download_references.sh       # Script to download from shared storage (future)
├── ww3_tp1.1/                   # Reference outputs for tp1.1 test
│   ├── ww3.19680601.nc          # NetCDF output file (field output)
│   ├── ww3.19680602.nc
│   ├── ...
│   ├── tab50.ww3                # Point output files
│   ├── metadata.json            # Test metadata (version, date, switches)
│   └── ww3_grid.out             # Grid preprocessing output
├── ww3_tp1.2/
│   └── ...
└── ...
```

## How Reference Outputs Are Generated

### Method 1: Local Generation (Recommended for Development)

Reference outputs are generated by running official WW3 with the same configuration:

1. **Install Official WW3 v6.07.1**:
   ```bash
   git clone https://github.com/NOAA-EMC/WW3.git
   cd WW3
   git checkout 6.07.1
   cd model
   # Follow WW3 installation instructions
   ```

2. **Generate Reference Outputs**:
   ```bash
   cd regtests/reference_outputs
   ./generate_references.sh tp1.1
   ```

   This script:
   - Compiles WW3 with appropriate switches
   - Runs ww3_grid, ww3_shel, ww3_ounf, ww3_ounp
   - Copies output files to this directory
   - Generates checksums and metadata

3. **Verify Checksums**:
   ```bash
   sha256sum -c CHECKSUMS.txt
   ```

### Method 2: Download from Shared Storage (Future)

For CI/CD and users without WW3 installation:

```bash
./download_references.sh tp1.1
```

This will download pre-generated reference outputs from:
- GitHub Releases (for small tests)
- Cloud storage (AWS S3, Google Cloud Storage) for large multi-grid tests
- Institutional FTP server (if available)

## File Types in Reference Outputs

### 1. NetCDF Field Output (ww3.YYYYMMDD.nc)
- **Generated by**: ww3_ounf (field output post-processor)
- **Contains**: 2D/3D gridded wave fields (HS, T01, DIR, etc.)
- **Size**: 100 KB - 50 MB depending on grid size and duration
- **Use**: Primary comparison target for spatial fields

### 2. Point Output (tab*.ww3, *.spec)
- **Generated by**: ww3_ounp (point output post-processor)
- **Contains**: Time series at specific locations
- **Size**: 1-10 KB per point
- **Use**: Time series validation, spectrum validation

### 3. Grid Preprocessing Output (ww3_grid.out)
- **Generated by**: ww3_grid (grid preprocessor)
- **Contains**: Grid metrics, bathymetry, masks
- **Size**: 10-500 KB
- **Use**: Verify grid setup is identical

### 4. Metadata (metadata.json)
- **Generated by**: generate_references.sh script
- **Contains**:
  ```json
  {
    "test_id": "ww3_tp1.1",
    "ww3_version": "6.07.1",
    "ww3_commit": "abc123...",
    "generation_date": "2026-02-10T12:00:00Z",
    "switches": "!/LN0 !/ST0 !/NL0 !/BT0 !/DB0 !/TR0 !/BS0 !/PRn",
    "compiler": "gfortran 9.4.0",
    "output_files": [
      {
        "filename": "ww3.19680601.nc",
        "sha256": "abc123...",
        "size_bytes": 123456
      }
    ]
  }
  ```
- **Use**: Track provenance, verify environment

## Storage Requirements

### Individual Tests (Estimated)

| Test Series | Files per Test | Size per Test | Total for Series |
|-------------|----------------|---------------|------------------|
| **tp1.x** (1-D) | 5-30 | 1-20 MB | ~150 MB |
| **tp2.x** (2-D) | 10-50 | 5-100 MB | ~1.5 GB |
| **mww3_test_xx** (Multi-grid) | 50-200 | 50-500 MB | ~8 GB |

### Complete Reference Suite

- **All tp1.x tests**: ~150 MB
- **All tp2.x tests**: ~1.5 GB
- **All mww3_test_xx tests**: ~8 GB
- **Total**: ~10 GB

### Git LFS Consideration

**Large binary files should NOT be committed to git directly.**

Options:
1. **Git LFS** (Large File Storage): Track reference outputs separately
2. **External Storage**: Store on cloud storage, download on demand
3. **.gitignore**: Exclude from repository, generate locally

**Current Approach**: `.gitignore` reference outputs, provide generation scripts.

## Tests with Available References

### Phase 1: tp1.x Tests (1-D Propagation)

| Test | Status | Output Files | Size | Notes |
|------|--------|--------------|------|-------|
| tp1.1 | ⏳ Pending | 25 NetCDF | ~5 MB | Equatorial propagation |
| tp1.2 | ⏳ Pending | 13 NetCDF | ~3 MB | Meridional propagation |
| tp1.3 | ⏳ Pending | 49 NetCDF | ~8 MB | Monochromatic shoaling |
| tp1.4 | ⏳ Pending | 49 NetCDF | ~10 MB | Spectral refraction (X) |
| tp1.5 | ⏳ Pending | 49 NetCDF | ~10 MB | Spectral refraction (Y) |
| tp1.6 | ⏳ Pending | 961 NetCDF | ~15 MB | Wave-current interaction |
| tp1.7 | ⏳ Pending | 361 NetCDF | ~12 MB | IG wave generation |
| tp1.8 | ⏳ Pending | 11 NetCDF | ~2 MB | Wave breaking on beach |
| tp1.9 | ⏳ Pending | 6 NetCDF | ~1 MB | Nonlinear shoaling (triads) |
| tp1.10 | ⏳ Pending | 55 NetCDF | ~8 MB | Bottom scattering |

**Total tp1.x**: ~74 MB

### Phase 2: tp2.x Tests (2-D Propagation)

| Test | Status | Output Files | Size | Notes |
|------|--------|--------------|------|-------|
| tp2.1 | ⏳ Pending | 25 NetCDF | ~20 MB | 2-D propagation |
| tp2.2 | ⏳ Pending | 25 NetCDF | ~20 MB | Periodic boundary |
| tp2.3 | ⏳ Pending | 121 NetCDF | ~50 MB | Curvilinear grid |
| tp2.4 | ⏳ Pending | 97 NetCDF | ~40 MB | Great Lakes (implemented) |
| ... | ⏳ Pending | ... | ... | Additional tp2.x tests |

**Total tp2.x**: ~1.5 GB (estimated)

### Phase 3: mww3_test_xx (Multi-Grid)

Multi-grid tests deferred until ww3_multi component complete.

## Generating Reference Outputs

### Prerequisites

1. **Official WW3 Installation**:
   - WW3 v6.07.1 compiled and in PATH
   - Required switches compiled for each test
   - Environment variable `WW3_DIR` set

2. **Disk Space**: At least 15 GB free for complete suite

3. **Time**: 10 minutes - 2 hours per test depending on:
   - Grid size
   - Duration
   - Number of output fields
   - CPU cores available

### Usage: generate_references.sh

```bash
# Generate single test reference
./generate_references.sh tp1.1

# Generate test series
./generate_references.sh tp1  # All tp1.x tests

# Generate all tp1.x and tp2.x
./generate_references.sh tp1 tp2

# Clean and regenerate
./generate_references.sh --clean tp1.1

# Dry run (show commands without executing)
./generate_references.sh --dry-run tp2.4
```

### What the Script Does

1. **Verify WW3 Installation**: Check `WW3_DIR` and executables
2. **Download Input Data**: Use `download_input_data.py` to fetch test inputs
3. **Compile Model**: Run `w3_make` with appropriate switches
4. **Execute WW3 Chain**:
   - `ww3_grid`: Generate grid
   - `ww3_shel`: Run model
   - `ww3_ounf`: Post-process field output
   - `ww3_ounp`: Post-process point output
5. **Copy Outputs**: Move results to `reference_outputs/ww3_tpX.X/`
6. **Generate Checksums**: Create SHA256 hashes for all files
7. **Create Metadata**: Record version, date, switches

### Expected Output

```
Generating reference outputs for tp1.1...
[1/6] Verifying WW3 installation... OK
[2/6] Downloading input data... OK (20 files)
[3/6] Compiling WW3 (switch_PR1)... OK (2m 15s)
[4/6] Running ww3_grid... OK (5s)
[5/6] Running ww3_shel... OK (45s)
[6/6] Post-processing outputs... OK (10s)

Reference outputs saved to: reference_outputs/ww3_tp1.1/
  - 25 NetCDF files (4.8 MB)
  - 1 metadata file
  - Checksums added to CHECKSUMS.txt

DONE: tp1.1 reference outputs generated successfully
```

## Downloading Pre-Generated References

### Usage: download_references.sh

```bash
# Download single test
./download_references.sh tp1.1

# Download test series
./download_references.sh tp1  # All tp1.x tests

# Verify downloaded files
./download_references.sh --verify tp1.1

# List available references without downloading
./download_references.sh --list
```

### Download Sources (Priority Order)

1. **GitHub Releases**: Small tests (tp1.x) as release assets
2. **Cloud Storage**: Large tests via direct HTTP download
3. **Institutional Mirror**: Alternative source if available

**Note**: Download infrastructure will be implemented after initial reference generation.

## Checksum Verification

### Verify All Reference Outputs

```bash
sha256sum -c CHECKSUMS.txt
```

### Verify Specific Test

```bash
sha256sum -c CHECKSUMS.txt | grep "ww3_tp1.1"
```

### Generate Checksums After Local Generation

```bash
# Automatically done by generate_references.sh
# Manual generation:
find reference_outputs/ -name "*.nc" -o -name "*.ww3" -o -name "*.spec" | \
  xargs sha256sum > CHECKSUMS.txt
```

## Comparison Workflow

### 1. Run rompy-ww3 Test

```python
# From regtests/ww3_tp1.1/
python rompy_ww3_tp1_1.py
# Outputs saved to rompy_runs/
```

### 2. Compare with Reference

```bash
# Use WW3 comparison tools or custom script
python ../compare_outputs.py \
  --reference reference_outputs/ww3_tp1.1/ \
  --result rompy_runs/ \
  --tolerance 1e-6
```

### 3. Evaluate Results

Acceptable differences:
- **Numerical Precision**: < 1e-6 relative error
- **Rounding Differences**: Expected due to compiler/architecture
- **Timestamp Metadata**: Can differ if run dates differ

Unacceptable differences:
- **Field Values**: > 1e-4 relative error (likely configuration bug)
- **Grid Dimensions**: Must match exactly
- **Missing Fields**: All fields must be present

## CI/CD Integration

### GitHub Actions Workflow

```yaml
name: Regression Tests with Reference Comparison

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      # Download reference outputs
      - name: Download tp1.1 reference
        run: |
          cd regtests/reference_outputs
          ./download_references.sh tp1.1
      
      # Run rompy-ww3 test
      - name: Run tp1.1 test
        run: |
          cd regtests/ww3_tp1.1
          python rompy_ww3_tp1_1.py
      
      # Compare outputs
      - name: Compare with reference
        run: |
          python regtests/compare_outputs.py \
            --reference regtests/reference_outputs/ww3_tp1.1/ \
            --result regtests/ww3_tp1.1/rompy_runs/ \
            --tolerance 1e-6
```

## Troubleshooting

### Missing WW3 Installation

**Error**: `WW3_DIR not set or ww3_grid not found`

**Solution**: Install WW3 or use pre-generated references via `download_references.sh`

### Disk Space

**Error**: `No space left on device`

**Solution**: 
- Generate references incrementally (one test at a time)
- Clean old `rompy_runs/` outputs
- Use external storage for large multi-grid tests

### Checksum Mismatch

**Error**: `ww3.19680601.nc: FAILED`

**Solutions**:
1. **Regenerate reference**: `./generate_references.sh --clean tp1.1`
2. **Re-download**: `./download_references.sh --force tp1.1`
3. **Check WW3 version**: Ensure v6.07.1 exactly
4. **Compiler differences**: May need tolerance adjustment

### Large File Download Failures

**Error**: `Connection timeout or incomplete download`

**Solutions**:
1. **Retry with resume**: `curl -C - <url>`
2. **Use alternative mirror**: Check script for mirror URLs
3. **Generate locally**: Use `generate_references.sh` instead

## Future Enhancements

### Planned Features

1. **Automated Reference Generation**: CI job to regenerate on WW3 version bump
2. **Cloud Storage Integration**: S3/GCS for large file hosting
3. **Delta Compression**: Store only differences between versions
4. **Parallel Generation**: Generate multiple tests concurrently
5. **Visualization**: Automated difference plots for failed comparisons

### Community Contributions

Reference outputs for additional tests welcome! To contribute:

1. Generate reference using `generate_references.sh`
2. Verify checksums
3. Submit PR with CHECKSUMS.txt update and metadata
4. Include WW3 version and compiler information

## Related Documentation

- [Input Data Documentation](../INPUT_DATA.md)
- [Regression Test Plan](.sisyphus/plans/ww3-regression-tests.md)
- [WW3 Official Documentation](https://github.com/NOAA-EMC/WW3/wiki)

## Contact

For issues with reference outputs:
- **GitHub Issues**: [rompy-ww3/issues](https://github.com/rom-py/rompy-ww3/issues)
- **Discussion**: [rompy-ww3/discussions](https://github.com/rom-py/rompy-ww3/discussions)

---

**Last Updated**: 2026-02-10
**Maintainer**: rompy-ww3 development team
